{% extends "base.html" %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Insurance Production Dashboard</h1>

<form action="{{ url_for('settings_update') }}" method="POST" class="mb-6 bg-white p-4 rounded shadow">
  <div class="flex items-end space-x-4">
    <div>
      <label class="block text-sm text-gray-500">Agency Goal ($)</label>
      <input type="number" name="agency_goal" step="0.01" class="border rounded px-3 py-2" value="{{ dash['agency_goal'] }}">
    </div>
    <button class="bg-blue-600 text-white px-4 py-2 rounded">Update Goal</button>
  </div>
</form>

<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-500">Total Agency Premium</div>
    <div class="text-3xl font-semibold">${{ '%.0f'|format(dash['total_premium'] or 0) }}</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-500">% to Goal</div>
    <div class="text-3xl font-semibold">{{ '%.1f'|format((dash['pct_to_goal'] or 0)*100) }}%</div>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="text-sm text-gray-500">Projected Month-End (Pace)</div>
    <div class="text-3xl font-semibold">${{ '%.0f'|format(dash['projected_month_end_premium'] or 0) }}</div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
  <div class="bg-white p-4 rounded shadow">
    <div class="font-semibold mb-2">Top Agents (Premium)</div>
    <canvas id="agentChart"></canvas>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="font-semibold mb-2">Premium by Category</div>
    <canvas id="categoryChart"></canvas>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
  <div class="bg-white p-4 rounded shadow">
    <div class="font-semibold mb-2">Agents</div>
    <table class="w-full text-sm">
      <thead><tr class="border-b"><th class="text-left py-2">Agent</th><th class="text-right">Quotes</th><th class="text-right">Sales</th><th class="text-right">Premium</th><th class="text-right">% Goal</th></tr></thead>
      <tbody>
        {% for r in agents %}
        <tr class="border-b last:border-none">
          <td class="py-2">{{ r['agent'] }}</td>
          <td class="text-right">{{ r['quotes'] }}</td>
          <td class="text-right">{{ r['sales'] }}</td>
          <td class="text-right">${{ '%.0f'|format(r['total_premium'] or 0) }}</td>
          <td class="text-right">{{ '%.1f'|format((r['pct_of_goal'] or 0)*100) }}%</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="font-semibold mb-2">Categories</div>
    <table class="w-full text-sm">
      <thead><tr class="border-b"><th class="text-left py-2">Category</th><th class="text-right">Quotes</th><th class="text-right">Sales</th><th class="text-right">Premium</th></tr></thead>
      <tbody>
        {% for r in cats %}
        <tr class="border-b last:border-none">
          <td class="py-2">{{ r['category'] }}</td>
          <td class="text-right">{{ r['quotes'] }}</td>
          <td class="text-right">{{ r['sales'] }}</td>
          <td class="text-right">${{ '%.0f'|format(r['total_premium'] or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <div class="bg-white p-4 rounded shadow">
    <div class="font-semibold mb-2">Lead Sources</div>
    <table class="w-full text-sm">
      <thead><tr class="border-b"><th class="text-left py-2">Lead Source</th><th class="text-right">Quotes</th><th class="text-right">Sales</th><th class="text-right">Premium</th></tr></thead>
      <tbody>
        {% for r in leads %}
        <tr class="border-b last:border-none">
          <td class="py-2">{{ r['lead_source'] }}</td>
          <td class="text-right">{{ r['quotes'] }}</td>
          <td class="text-right">{{ r['sales'] }}</td>
          <td class="text-right">${{ '%.0f'|format(r['total_premium'] or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
async function loadChart(id, url) {
  const ctx = document.getElementById(id);
  const res = await fetch(url);
  const data = await res.json();
  new Chart(ctx, {
    type: 'bar',
    data: { labels: data.labels, datasets: [{ label: 'Premium', data: data.values }] },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
  });
}
loadChart('agentChart', '{{ url_for("chart_agent_premium") }}');
loadChart('categoryChart', '{{ url_for("chart_category_premium") }}');
</script>
{% endblock %}